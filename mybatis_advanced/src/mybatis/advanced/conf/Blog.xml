<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatis.advanced">
	
	<resultMap id="blogResultMap" type="Blog">
		<id property="blogId" column="blog_id" />
		<result property="blogName" column="blog_name" />		
		<result property="blogTitle" column="blog_title" />
		<association property="author" column="author_id" 
			javaType="Author" resultMap="authorResultMap" />
		<collection property="commList" ofType="Comm" 
			resultMap="commResultMap" />
	</resultMap>

	<resultMap id="authorResultMap" type="Author">
		<id property="authorId" column="author_id" />
		<result property="authorName" column="author_name" />
	</resultMap>

	<resultMap id="commResultMap" type="Comm">
		<id property="commId" column="comm_id" />
		<result property="commTitle" column="comm_title" />
		<result property="commContent" column="comm_content" />
		<result property="blogId" column="blog_id" />
	</resultMap>
	
	<select id="selectBlog" resultMap="blogResultMap">
		select 
			b.blog_id, b.blog_name, b.blog_title, b.author_id,
			a.author_id, a.author_name,
			c.comm_id, c.comm_title, c.comm_content, c.blog_id
		from blog b
			left outer join author a on b.author_id = a.author_id
			left outer join comm c on c.blog_id = b.blog_id
		order by b.blog_id desc
	</select>
	
	<sql id="selectCommLet">
		select comm_id, comm_title, comm_content, blog_id
		from comm
	</sql>
	
	<select id="selectCommByBlogId" parameterType="CommSearcher"
		resultMap="commResultMap">
		<include refid="selectCommLet" />
		where blog_id = #{blogId}
		<if test="searchValue!=null">
			<if test="searchKey=='title'">
				and comm_title like '%'||#{searchValue}||'%'
			</if>
			<if test="searchKey=='content'">
				and comm_content like '%'||#{searchValue}||'%'
			</if>
			<!--
				<choose>
					<when test="searchKey=='title'">
						and comm_title like '%'||#{searchValue}||'%'
					</when>
					<when test="searchKey=='content'">
						and comm_content like '%'||#{searchValue}||'%'
					</when>
					<otherwise>
						and 1=1
					</otherwise>
				</choose>
			-->
		</if>
		order by comm_id desc
	</select>

	<select id="selectCommsByCommIds" parameterType="list"
		resultMap="commResultMap">
		<include refid="selectCommLet" />
		<where>
			blog_id=#{list[0]}
			and comm_id in 
			<foreach item="item" index="index" collection="list"
				open="(" separator="," close=")">
				#{item}
			</foreach>
		</where>	
	</select>
	
	<update id="updateComm" parameterType="Comm">
		update comm
		<trim prefix="set" suffixOverrides=",">
			<if test="commTitle!=null">comm_title=#{commTitle},</if>
			<if test="commContent!=null">comm_content=#{commContent}</if>
		</trim>
		<where>
			<if test="commId!=null">comm_id=#{commId}</if>
			<if test="blogId!=null">and blog_id=#{blogId}</if>
		</where>
	</update>

</mapper>
















